#!/usr/bin/env bash
set +e

puts-step "Initializing .condarc"
touch /app/.heroku/miniconda/.condarc
if [[ -f .condarc ]]; then
  cp -f .condarc /app/.heroku/miniconda
fi

echo "nomkl" > $HOME/.heroku/miniconda/conda-meta/pinned
echo "python <3.8.0" >> $HOME/.heroku/miniconda/conda-meta/pinned
# Pin the conda version if proper version, not `latest` or anything else
if [[ $CONDA_VERSION =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
    echo "conda ==${CONDA_VERSION}" >> $HOME/.heroku/miniconda/conda-meta/pinned
fi

conda config --set always_yes True
conda config --set auto_update_conda False
conda config --set show_channel_urls True
conda config --set update_dependencies False
conda config --add create_default_packages nomkl
conda config --add create_default_packages pip

puts-step "Installing dependencies using Conda"
conda install $MINICONDA_VERBOSITY --file conda-requirements.txt | indent

if [[ -f requirements.txt ]]; then
  puts-step "Installing dependencies using Pip"
  pip install -r requirements.txt  --exists-action=w | indent
fi

puts-step "Cleaning the conda environment"
conda clean -pt --yes > /dev/null
